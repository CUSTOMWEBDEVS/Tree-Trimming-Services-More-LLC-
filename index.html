<!DOCTYPE html>
<html lang="en" id="top">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tree Trimming Services & More LLC</title>
  <meta name="description" content="Insured, professional tree work. 16+ years experience. Call or text +1 (573) 915-3370." />
  <meta name="theme-color" content="#0b0d11" />
  <link rel="icon" href="images/weblogo.jpg" type="image/jpeg" />
  <style>
    :root{
      --bg:#0b0d11; --card:#15151e; --panel:#101014;
      --text:#f1f1f1; --muted:#b9beca; --line:rgba(255,255,255,.1);
      --ac1:#8f63ff; --ac2:#5a45c9; --ring:0 0 0 3px rgba(143,99,255,.25);
      --maxw:1100px; --navH:64px; --carouselMax:min(70vh,620px);
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);overflow-x:hidden}
    img,svg,video{max-width:100%;height:auto}
    a{color:#cfc7ff;text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:16px;display:grid;gap:28px}
    .break{word-wrap:break-word;overflow-wrap:break-word}

    /* ===== Fixed navbar (always visible) ===== */
    .nav{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#0d0f15cc; backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line)
    }
    .nav-inner{max-width:var(--maxw);margin:0 auto;height:var(--navH);display:flex;align-items:center;gap:10px;padding:0 12px}
    .logo{display:flex;align-items:center;gap:10px;min-width:0}
    .logo svg{width:44px;height:auto;flex:0 0 auto}
    .brand{font-weight:900;letter-spacing:.2px;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .spacer{flex:1}
    .menu-btn{display:inline-flex;align-items:center;justify-content:center;width:44px;height:40px;border-radius:10px;border:1px solid var(--line);background:#121421;color:#fff;cursor:pointer}
    .menu-btn:focus-visible{outline:3px solid #8f63ff}

    /* Dropdown inside fixed nav; page content is pushed by #nav-spacer */
    .menu{display:none}
    .menu.open{display:grid;gap:8px;max-width:var(--maxw);margin:8px auto;padding:10px;background:#0f1118;border:1px solid var(--line);border-radius:12px}
    .menu a{display:block;text-decoration:none;border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-weight:750;color:#dfe3ef;background:#141622}
    .menu a:hover{background:#1a1d2a}
    .menu .call{background:linear-gradient(180deg,#6f54e9,var(--ac2));color:#fff;border-color:var(--line);text-align:center}

    header{text-align:center;padding:8px 0}
    header h1{margin:0;font-size:clamp(1.5rem,1.1rem + 1.6vw,2.1rem)}
    header p{margin:.35rem 0 0;color:var(--muted)}

    /* carousel */
    .carousel{border-radius:12px;overflow:hidden;background:#0e0f19}
    .carousel-inner{display:flex;justify-content:center;align-items:center;padding:6px}
    .carousel img{display:block;max-height:var(--carouselMax);object-fit:contain;border-radius:10px;transition:opacity .35s ease}
    .carousel.fading img{opacity:.08}

    /* sections */
    .sect{display:grid;gap:14px;scroll-margin-top:calc(var(--navH) + 12px)}
    .sect h3{margin:0;font-size:1.22rem;border-bottom:1px solid var(--line);padding-bottom:8px}

    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:linear-gradient(180deg,var(--card),var(--panel));border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 10px 34px rgba(0,0,0,.32)}
    .card h4{margin:.1rem 0 .4rem;font-size:1.05rem}
    .card p{margin:0;color:var(--muted)}

    .badges{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .badge{display:flex;align-items:center;gap:10px;background:#0f1118;border:1px solid var(--line);border-radius:12px;padding:12px}
    .badge .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#cfc7ff 60%,#8f63ff);box-shadow:0 0 16px rgba(143,99,255,.45)}

    .steps{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .step{background:#11131c;border:1px solid var(--line);border-radius:12px;padding:14px}
    .num{display:inline-block;background:#1f2140;color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;margin-bottom:8px}

    .thumbs{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
    .thumbs img{width:100%;height:120px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .thumbs figure{margin:0}
    .thumbs figcaption{font-size:.85rem;color:var(--muted);margin-top:6px}

    /* reviews */
    .quotes{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .quote{background:#121422;border:1px solid var(--line);border-radius:12px;padding:16px;position:relative}
    .quote::before{content:"“";position:absolute;left:12px;top:-8px;font-size:3rem;color:#4d4f66;opacity:.35}
    .quote .by{margin-top:8px;color:#d6d8e3;font-weight:700}
    .rating-badge{display:inline-flex;align-items:center;gap:8px;background:#0f1118;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-weight:800}
    .src-tag{padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#0f1118;margin-left:6px;font-size:.8rem}

    /* faqs */
    .faqs details{background:#0f1118;border:1px solid var(--line);border-radius:12px;padding:12px 14px}
    .faqs summary{cursor:pointer;font-weight:700}
    .faqs p{color:var(--muted);margin:.5rem 0 0}

    /* forms */
    .quote-wrap{max-width:860px;margin:8px auto 0;width:100%}
    .quote-title{text-align:center;font-weight:900;font-size:1.35rem;margin:2px 0 10px}
    .quote-card{background:linear-gradient(180deg,#20202a,#1b1b24);border:1px solid var(--line);border-radius:16px;padding:18px}
    .qgrid{display:grid;gap:14px}
    .field{display:grid;gap:6px}
    .label{color:var(--muted);font-size:.92rem}
    .input,.select,.textarea{
      width:100%; background:#0f121a; color:var(--text);
      border:1px solid var(--line); border-radius:12px; padding:12px 14px; outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus,.select:focus,.textarea:focus{border-color:#8f63ff;box-shadow:var(--ring)}
    .textarea{min-height:120px;resize:vertical}
    .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:6px}
    .btnP{background:linear-gradient(180deg,#6f54e9,var(--ac2));color:#fff;border:1px solid var(--line);border-radius:12px;padding:12px 18px;font-weight:800}
    .btnS{background:#181a22;color:#dfe3ef;border:1px solid var(--line);border-radius:12px;padding:12px 18px;font-weight:800}
    .help{text-align:center;color:var(--muted);font-size:.92rem;margin-top:6px}
    @media (min-width:720px){.qgrid{grid-template-columns:1fr 1fr}.span-2{grid-column:1/-1}}

    /* CTA */
    .cta{background:linear-gradient(90deg,#1c1d2f,#171828);border:1px solid var(--line);border-radius:14px;padding:18px;display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    .cta strong{font-size:1.05rem}

    /* sticky mobile call bar */
    .sticky-call{position:fixed;left:0;right:0;bottom:0;background:#0d0e14cc;backdrop-filter:blur(8px);border-top:1px solid var(--line);padding:10px;display:flex;gap:10px;justify-content:center;z-index:50}
    .sticky-call a{flex:1;max-width:420px;text-align:center}
    @media (min-width:760px){.sticky-call{display:none}}

    footer{color:var(--muted);text-align:center;padding:18px 0 80px}

    /* ===== Admin modal ===== */
    body.modal-open { overflow: hidden; }              /* lock background */
    .modal{position:fixed; inset:0; display:none; z-index:1200; background:rgba(0,0,0,.55); backdrop-filter:blur(4px); align-items:flex-start; justify-content:center; padding:24px;}
    .modal.open{display:flex}
    .modal-card{width:min(100%,980px); background:#10131a; border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 30px 80px rgba(0,0,0,.5); max-height:92vh; overflow:auto; outline:none;}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .x{border:1px solid var(--line);background:#181a22;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .dash{display:grid;gap:16px}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .kpi{background:#0f1118;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .val{font-size:1.6rem;font-weight:900}
    .table{width:100%;border-collapse:collapse;font-size:.95rem}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:left}
    .row-actions{display:flex;gap:8px}
    .danger{background:#3c1220;border:1px solid #5b2032;color:#ffdbe4;border-radius:10px;padding:6px 10px}
    .ok{background:#162c22;border:1px solid #234538;color:#d2ffe6;border-radius:10px;padding:6px 10px}
    .login-grid{display:grid;gap:12px;grid-template-columns:1fr auto}
    .login-grid .input{height:44px}
    .hidden{display:none !important}
  </style>
</head>
<body>

  <!-- Fixed nav with animated logo + hamburger + Admin -->
  <nav class="nav" role="navigation" aria-label="Main">
    <div class="nav-inner">
      <div class="logo">
        <!-- animated logo -->
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <image id="src" href="logo-silhouette.png" width="1024" height="1024"/>
            <clipPath id="tL"><rect x="170" y="150" width="280" height="560" rx="18"/></clipPath>
            <clipPath id="tR"><rect x="590" y="140" width="260" height="560" rx="18"/></clipPath>
            <clipPath id="deer"><rect x="410" y="490" width="250" height="220" rx="14"/></clipPath>
            <clipPath id="grass"><rect x="170" y="630" width="684" height="86" rx="10"/></clipPath>
            <clipPath id="water"><rect x="130" y="690" width="764" height="170" rx="10"/></clipPath>
            <clipPath id="all"><rect x="0" y="0" width="1024" height="1024"/></clipPath>
            <filter id="flow" x="-10%" y="-10%" width="120%" height="120%" filterUnits="userSpaceOnUse" filterRes="1024">
              <feTurbulence type="fractalNoise" baseFrequency="0.02 0.05" numOctaves="2" seed="7" result="n">
                <animate attributeName="baseFrequency" dur="6s" repeatCount="indefinite" values="0.02 0.05; 0.026 0.06; 0.02 0.05"/>
              </feTurbulence>
              <feDisplacementMap in="SourceGraphic" in2="n" scale="8" xChannelSelector="R" yChannelSelector="G">
                <animate attributeName="scale" dur="6s" repeatCount="indefinite" values="8;10;8"/>
              </feDisplacementMap>
            </filter>
          </defs>
          <g clip-path="url(#all)"><use href="#src"/></g>
          <g clip-path="url(#tL)" style="transform-box:fill-box;transform-origin:50% 100%"><animateTransform attributeName="transform" type="rotate" dur="6s" repeatCount="indefinite" values="0; -0.9; 0.3; -0.6; 0"/><use href="#src"/></g>
          <g clip-path="url(#tR)" style="transform-box:fill-box;transform-origin:50% 100%"><animateTransform attributeName="transform" type="rotate" begin=".35s" dur="6s" repeatCount="indefinite" values="0; -0.8; 0.25; -0.5; 0"/><use href="#src"/></g>
          <g clip-path="url(#deer)"><g style="transform-box:fill-box;transform-origin:50% 85%"><animateTransform attributeName="transform" type="translate" begin=".1s" dur="6s" repeatCount="indefinite" values="0 0; 0 -8; 0 0; 0 -7; 0 0"/><g style="transform-box:fill-box;transform-origin:50% 85%"><animateTransform attributeName="transform" type="rotate" begin=".1s" dur="6s" repeatCount="indefinite" values="0; -0.9; 0.4; -0.6; 0"/><use href="#src"/></g></g></g>
          <g clip-path="url(#grass)" style="transform-box:fill-box;transform-origin:50% 100%"><animateTransform attributeName="transform" type="skewX" begin=".1s" dur="6s" repeatCount="indefinite" values="0; -1.2; 0.7; -1.0; 0"/><animateTransform attributeName="transform" additive="sum" type="translate" begin=".1s" dur="6s" repeatCount="indefinite" values="0 0; 0 -1; 0 0; 0 -1; 0 0"/><use href="#src"/></g>
          <g clip-path="url(#water)"><animateTransform attributeName="transform" type="translate" dur="6s" repeatCount="indefinite" values="0 0; 4 0; 0 0"/><use href="#src" filter="url(#flow)"/></g>
        </svg>
        <div class="brand">Tree Trimming Services & More LLC</div>
      </div>

      <div class="spacer"></div>

      <!-- hamburger only -->
      <button class="menu-btn" id="menubtn" aria-label="Menu" aria-controls="dropmenu" aria-expanded="false">☰</button>
    </div>

    <!-- dropdown that pushes page down (via #nav-spacer) -->
    <div class="menu" id="dropmenu">
      <a href="#gallery">Gallery</a>
      <a href="#services">Services</a>
      <a href="#process">Process</a>
      <a href="#jobs">Recent</a>
      <a href="#reviews">Reviews</a>
      <a href="#faq">FAQ</a>
      <a href="#booking">Quote</a>
      <a id="adminOpen" href="#admin">Admin</a>
      <a class="call" href="tel:+15739153370">📞 Call</a>
    </div>
  </nav>

  <!-- Spacer below fixed nav; grows when menu opens -->
  <div id="nav-spacer" style="height: var(--navH)"></div>

  <div class="wrap">
    <header>
      <h1 class="break">Tree Trimming Services &amp; More LLC</h1>
      <p>Insured • 16+ yrs experience • Call or text <strong>(573) 915-3370</strong></p>
    </header>

    <!-- GALLERY -->
    <section class="carousel sect" id="gallery" aria-label="Work gallery">
      <div class="carousel-inner">
        <img id="carousel-img" src="images/1.jpg" alt="Tree work photo 1" loading="eager" decoding="async" />
      </div>
    </section>

    <!-- WHY -->
    <section class="sect" id="why">
      <h3>Why choose us</h3>
      <div class="badges">
        <div class="badge"><span class="dot"></span><div><strong>Insured &amp; local</strong><div style="color:var(--muted)">Based in Valles Mines, MO</div></div></div>
        <div class="badge"><span class="dot"></span><div><strong>16+ yrs experience</strong><div style="color:var(--muted)">Precision &amp; safety focused</div></div></div>
        <div class="badge"><span class="dot"></span><div><strong>Clean job sites</strong><div style="color:var(--muted)">Brush &amp; haul-away available</div></div></div>
        <div class="badge"><span class="dot"></span><div><strong>Fair, clear pricing</strong><div style="color:var(--muted)">Free quotes, no surprises</div></div></div>
      </div>
    </section>

    <!-- SERVICES -->
    <section class="sect" id="services">
      <h3>Services</h3>
      <div class="grid">
        <article class="card"><h4>✂️ Pruning &amp; Crown Care</h4><p>Health-first trimming, deadwood removal, canopy shaping, and structural balance.</p></article>
        <article class="card"><h4>🪓 Controlled Removals</h4><p>Tight-space sectional takedowns with rigging and lowering—precision work.</p></article>
        <article class="card"><h4>🌩️ Storm Damage &amp; Hazard Cleanup</h4><p>Emergency response, hangers cleared, broken limbs secured, and debris hauled.</p></article>
        <article class="card"><h4>🧹 Brush &amp; Haul-Away</h4><p>Clean work sites every time—chip, stack, or full removal.</p></article>
      </div>
    </section>

    <!-- PROCESS -->
    <section class="sect" id="process">
      <h3>Our process</h3>
      <div class="steps">
        <div class="step"><span class="num">1</span><h4>Walk-through</h4><p class="muted">We listen, assess trees, and discuss options on-site or via photos.</p></div>
        <div class="step"><span class="num">2</span><h4>Clear quote</h4><p class="muted">Written scope, price, and timing—no surprises.</p></div>
        <div class="step"><span class="num">3</span><h4>Safe execution</h4><p class="muted">Professional rigging, sectional removals, careful protection of your property.</p></div>
        <div class="step"><span class="num">4</span><h4>Clean finish</h4><p class="muted">Brush/wood handled as requested. We leave it tidy.</p></div>
      </div>
    </section>

    <!-- RECENT -->
    <section class="sect" id="jobs">
      <h3>Recent jobs</h3>
      <div class="thumbs">
        <figure><img src="images/1.jpg" alt="Job 1"><figcaption>Selective pruning</figcaption></figure>
        <figure><img src="images/2.jpg" alt="Job 2"><figcaption>Sectional removal</figcaption></figure>
        <figure><img src="images/3.jpg" alt="Job 3"><figcaption>Storm cleanup</figcaption></figure>
        <figure><img src="images/4.jpg" alt="Job 4"><figcaption>Brush &amp; haul-away</figcaption></figure>
        <figure><img src="images/5.jpg" alt="Job 5"><figcaption>Canopy balance</figcaption></figure>
      </div>
    </section>

    <!-- REVIEWS -->
    <section class="sect" id="reviews">
      <h3>Reviews</h3>
      <div id="reviewsHeader" class="rating-badge" aria-live="polite">Average: —</div>
      <div id="reviewsList" class="quotes" style="margin-top:10px" aria-live="polite"></div>

      <form id="reviewForm" class="quote-card" autocomplete="off">
        <div class="qgrid">
          <div class="field">
            <label class="label" for="rname">Your name</label>
            <input id="rname" name="name" class="input" type="text" placeholder="Jane D." required>
          </div>
          <div class="field">
            <label class="label" for="rstars">Rating</label>
            <select id="rstars" name="stars" class="select" required>
              <option value="5" selected>★★★★★</option>
              <option value="4">★★★★☆</option>
              <option value="3">★★★☆☆</option>
              <option value="2">★★☆☆☆</option>
              <option value="1">★☆☆☆☆</option>
            </select>
          </div>
          <div class="field span-2">
            <label class="label" for="rtext">Review</label>
            <textarea id="rtext" name="text" class="textarea" placeholder="How did we do?" required></textarea>
          </div>
          <div class="actions span-2">
            <button class="btnP" type="submit">Post review</button>
          </div>
          <div id="reviewStatus" class="help span-2"></div>
        </div>
      </form>
    </section>

    <!-- FAQ -->
    <section class="sect faqs" id="faq">
      <h3>FAQ</h3>
      <details><summary>Are you insured?</summary><p>Yes. We carry full liability insurance and can provide proof on request.</p></details>
      <details><summary>Do you handle tight spaces?</summary><p>Yes—sectional removals with rigging and controlled lowering where equipment can’t reach.</p></details>
      <details><summary>What about cleanup?</summary><p>We can chip, stack, or haul away brush/logs depending on your preference.</p></details>
    </section>

    <!-- QUOTE -->
    <section class="quote-wrap" id="booking">
      <h2 class="quote-title">Request a quote</h2>
      <form id="quoteForm" class="quote-card" novalidate>
        <div class="qgrid">
          <div class="field">
            <label class="label" for="name">Name</label>
            <input id="name" name="name" class="input" type="text" placeholder="Jane Doe" required>
          </div>
          <div class="field">
            <label class="label" for="phone">Phone</label>
            <input id="phone" name="phone" class="input" type="tel" placeholder="(573) 555-0123" required>
          </div>
          <div class="field span-2">
            <label class="label" for="address">Address</label>
            <input id="address" name="address" class="input" type="text" placeholder="Street • City • ZIP — e.g., Valles Mines, MO 63087">
          </div>
          <div class="field">
            <label class="label" for="service">Service</label>
            <select id="service" name="service" class="select" required>
              <option value="" selected>Choose…</option>
              <option>Pruning & Crown Care</option>
              <option>Controlled Removal</option>
              <option>Storm Damage & Hazard Cleanup</option>
              <option>Brush & Haul-Away</option>
            </select>
          </div>
          <div class="field span-2">
            <label class="label" for="details">Details</label>
            <textarea id="details" name="details" class="textarea" placeholder="Trees, access, timing…"></textarea>
          </div>
          <div class="actions span-2">
            <button class="btnP" type="submit">Send request</button>
            <a class="btnS" href="tel:+15739153370">Call</a>
            <a class="btnS" href="sms:+15739153370">Text</a>
          </div>
          <div id="quoteStatus" class="help span-2">Local to Valles Mines, MO. References on request.</div>
        </div>
      </form>
    </section>

    <footer>
      &copy; <span id="yr"></span> Tree Trimming Services &amp; More LLC •
      <a href="https://www.facebook.com/treetrimmingservicesandmoreLLC2015" target="_blank" rel="noopener noreferrer">Facebook</a>
    </footer>
  </div>

  <!-- sticky mobile actions -->
  <div class="sticky-call" role="navigation" aria-label="Quick actions">
    <a class="btnP" href="tel:+15739153370">📞 Call</a>
    <a class="btnS" href="sms:+15739153370">💬 Text</a>
  </div>

  <!-- ===== Admin Modal ===== -->
  <div id="adminModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="dashTitle">
      <div class="modal-head">
        <h3 id="dashTitle" style="margin:0">Admin Dashboard</h3>
        <div style="display:flex; gap:8px">
          <button id="adminLogout" class="x hidden">Log out</button>
          <button id="adminClose" class="x">Close</button>
        </div>
      </div>

      <!-- Login -->
      <div id="adminLoginView">
        <p class="help" style="margin-top:0">Enter admin password to manage reviews, view analytics, and send updates.</p>
        <div class="login-grid">
          <input id="adminPass" class="input" type="password" placeholder="Admin password" autocomplete="current-password" />
          <button id="adminLoginBtn" class="btnP" type="button">Unlock</button>
        </div>
        <div id="adminLoginMsg" class="help"></div>
      </div>

      <!-- Dashboard -->
      <div id="adminDashView" class="dash hidden">
        <section>
          <h4 style="margin:0 0 8px 0">Key metrics</h4>
          <div class="kpis">
            <div class="kpi"><div>Total Reviews</div><div class="val" id="k_totalReviews">—</div></div>
            <div class="kpi"><div>Average Rating</div><div class="val" id="k_avgRating">—</div></div>
            <div class="kpi"><div>Reviews (this month)</div><div class="val" id="k_reviewsMonth">—</div></div>
            <div class="kpi"><div>Total Quotes</div><div class="val" id="k_totalQuotes">—</div></div>
            <div class="kpi"><div>Quotes (this month)</div><div class="val" id="k_quotesMonth">—</div></div>
          </div>
        </section>

        <section>
          <h4 style="margin:0 0 8px 0">Recent Quotes</h4>
          <div style="overflow:auto">
            <table class="table" id="quotesTable">
              <thead><tr><th>Date</th><th>Name</th><th>Phone</th><th>Service</th><th>City/ZIP</th><th>Details</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section>
          <h4 style="margin:0 0 8px 0">Manage Reviews</h4>
          <p class="help" style="margin:.2rem 0 .8rem">You can delete any website review below. (Facebook reviews are read-only.)</p>
          <div id="adminReviews" class="quotes"></div>
        </section>

        <section>
          <h4 style="margin:0 0 8px 0">Send Update</h4>
          <div class="qgrid">
            <input id="updSubject" class="input span-2" type="text" placeholder="Subject (e.g., Schedule update)" />
            <textarea id="updBody" class="textarea span-2" placeholder="Message to send to the list or admin email."></textarea>
            <input id="updRecipients" class="input span-2" type="text" placeholder="Recipients (optional, comma-separated). Leave blank to use default list." />
            <div class="actions span-2">
              <button id="sendUpdateBtn" class="ok" type="button">Send update email</button>
              <div id="sendUpdateMsg" class="help"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
  // ===== CONFIG =====
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwAuB0oxQrPcAowEWA4Pz9WhlNyKYp4_pxV3u-PpvRMBPC1uy5XEK4naNu2FpodJL2z/exec'; // your /exec
  document.getElementById('yr').textContent = new Date().getFullYear();

  // ===== Fixed nav =====
  const btn = document.getElementById('menubtn');
  const drop = document.getElementById('dropmenu');
  function updateNavSpacer() {
    const spacer = document.getElementById('nav-spacer');
    const base = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--navH')) || 64;
    const extra = drop.classList.contains('open') ? (drop.scrollHeight + 8) : 0;
    spacer.style.height = (base + extra) + 'px';
  }
  const closeMenu = () => { drop.classList.remove('open'); btn.setAttribute('aria-expanded','false'); updateNavSpacer(); };
  btn.addEventListener('click', ()=>{ const open = drop.classList.toggle('open'); btn.setAttribute('aria-expanded', String(open)); updateNavSpacer(); });
  drop.querySelectorAll('a[href^="#"]').forEach(a=>a.addEventListener('click', (e)=>{ e.preventDefault(); const el = document.getElementById(a.getAttribute('href').slice(1)); closeMenu(); setTimeout(()=>{ el?.scrollIntoView({behavior:'smooth', block:'start'}); }, 50); }));
  document.addEventListener('click', (e)=>{ if(!drop.contains(e.target) && e.target !== btn) closeMenu(); });
  addEventListener('resize', updateNavSpacer); addEventListener('orientationchange', updateNavSpacer);

  // ===== Carousel =====
  const imgs = ['images/1.jpg','images/2.jpg','images/3.jpg','images/4.jpg','images/5.jpg'];
  const cEl = document.getElementById('gallery'); const imgEl = document.getElementById('carousel-img'); let i = 0;
  imgs.forEach(src => { const im = new Image(); im.src = src; });
  setInterval(()=>{ cEl.classList.add('fading'); setTimeout(()=>{ i=(i+1)%imgs.length; imgEl.src=imgs[i]; imgEl.alt='Tree work photo '+(i+1); cEl.classList.remove('fading'); },220); },4000);

  // ===== Helpers =====
  const escapeHtml = (s='') => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const safeDate = t => { try{return new Date(t).toLocaleDateString()}catch{return ''} };

  // ===== JSONP helper =====
  function jsonp(params){
    return new Promise((resolve,reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const q = new URLSearchParams(Object.fromEntries(Object.entries(params).map(([k,v])=>[k, String(v ?? '')])));
      q.set('callback', cb);
      const s = document.createElement('script');
      s.src = `${GAS_URL}?${q.toString()}`;
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP network error')); };
      function cleanup(){ delete window[cb]; s.remove(); }
      window[cb] = (data)=>{ try{ resolve(data); } finally { cleanup(); } };
      document.body.appendChild(s);
    });
  }

  // ===== Reviews (PUBLIC LIST — NO DELETE BUTTONS) =====
  function renderReviewsPublic(list){
    const nums = (Array.isArray(list)?list:[]).map(r => Number(r.stars)||0).filter(n => n>0);
    const avg = nums.length ? (nums.reduce((a,b)=>a+b,0)/nums.length) : 0;
    document.getElementById('reviewsHeader').innerHTML =
      `<span>Average: ${avg ? avg.toFixed(1) : '—'}</span>
       <span>${'★'.repeat(Math.round(avg))}${'☆'.repeat(5-Math.round(avg))}</span>
       <span style="color:var(--muted);font-weight:600">(${nums.length})</span>`;

    const box = document.getElementById('reviewsList');
    // No admin class here; public list never exposes delete
    box.innerHTML = (Array.isArray(list) && list.length) ? list.map(r => `
      <div class="quote" data-id="${r.id ?? ''}">
        <div>${'★'.repeat(+r.stars)}${'☆'.repeat(5-+r.stars)}</div>
        <div style="margin-top:6px">${escapeHtml(r.text)}</div>
        <div class="by">— ${escapeHtml(r.name)}
          <span style="color:var(--muted);font-weight:400">• ${safeDate(r.timestamp)}
            <span class="src-tag">${r.source === 'facebook' ? 'Facebook' : 'Website'}</span>
          </span>
        </div>
      </div>`).join('') : '<div class="help">No reviews yet — be the first!</div>';
  }

  async function loadReviews(){
    try{
      const data = await jsonp({action:'list'});
      renderReviewsPublic(Array.isArray(data)?data:[]);
    }catch{
      document.getElementById('reviewsList').innerHTML = '<div class="help">Couldn’t load reviews.</div>';
    }
  }

  // ===== Quote form =====
  document.getElementById('quoteForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const status = document.getElementById('quoteStatus');
    status.textContent = 'Sending request...';
    try{
      const ok = await jsonp({
        action:'quote',
        name:(fd.get('name')||'').toString().trim(),
        phone:(fd.get('phone')||'').toString().trim(),
        address:(fd.get('address')||'').toString().trim(),
        service:fd.get('service'),
        details:(fd.get('details')||'').toString().trim()
      });
      if(ok?.ok || ok?.success){ status.textContent = 'Request sent! We’ll reach out shortly.'; e.target.reset(); }
      else{ status.textContent = 'Couldn’t send request.'; }
    }catch{ status.textContent = 'Network error.'; }
  });

  // ===== Reviews form =====
  document.getElementById('reviewForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const status = document.getElementById('reviewStatus');
    status.textContent = 'Posting...';
    try{
      const ok = await jsonp({
        action:'add',
        name:(fd.get('name')||'').toString().trim(),
        stars:fd.get('stars'),
        text:(fd.get('text')||'').toString().trim()
      });
      if(ok?.ok || ok?.success){ status.textContent = 'Thanks for the review!'; e.target.reset(); loadReviews(); }
      else{ status.textContent = 'Couldn’t post review.'; }
    }catch{ status.textContent = 'Network error.'; }
  });

  // ===== Admin modal & auth (JSONP) =====
  const adminModal = document.getElementById('adminModal');
  const adminOpenBtn = document.getElementById('adminOpen');
  const adminCloseBtn = document.getElementById('adminClose');
  const adminLogoutBtn = document.getElementById('adminLogout');
  const adminLoginView = document.getElementById('adminLoginView');
  const adminDashView = document.getElementById('adminDashView');
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminLoginMsg = document.getElementById('adminLoginMsg');
  const adminPass = document.getElementById('adminPass');
  let adminOpen = false;

  function isAuthed(){ return !!localStorage.getItem('adminToken'); }
  function setAuthed(token){
    if(token){ localStorage.setItem('adminToken', token); }
    adminLoginView.classList.add('hidden');
    adminDashView.classList.remove('hidden');
    adminLogoutBtn.classList.remove('hidden');
    // NOTE: we no longer toggle any global "admin" class on <body>, so public list never shows deletes.
  }
  function clearAuthed(){
    localStorage.removeItem('adminToken');
    adminLoginView.classList.remove('hidden');
    adminDashView.classList.add('hidden');
    adminLogoutBtn.classList.add('hidden');
  }

  function showModal(open){
    adminModal.classList.toggle('open', open);
    adminModal.setAttribute('aria-hidden', String(!open));
    adminOpen = open;
    document.body.classList.toggle('modal-open', open); // lock background scroll
    if (open) {
      const card = adminModal.querySelector('.modal-card');
      if (card && !card.hasAttribute('tabindex')) card.setAttribute('tabindex','-1');
      setTimeout(()=> card?.focus({preventScroll:true}), 0);
    }
  }

  // prevent touch scroll leaking to page
  document.addEventListener('touchmove', (e)=>{
    if (adminOpen && !adminModal.contains(e.target)) e.preventDefault();
  }, { passive:false });

  adminOpenBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeMenu(); openAdmin(); });
  adminCloseBtn.addEventListener('click', ()=>{ showModal(false); stopAdminTimer(); });
  adminModal.addEventListener('click', (e)=>{ if(e.target===adminModal){ showModal(false); stopAdminTimer(); } });
  adminLogoutBtn.addEventListener('click', ()=>{ clearAuthed(); });

  async function openAdmin(){
    showModal(true);
    adminLoginMsg.textContent = '';
    if(isAuthed()){ await adminRefresh(); } else { clearAuthed(); }
    adminPass.focus();
    startAdminTimer();
  }

  adminLoginBtn.addEventListener('click', async ()=>{
    const pwd = adminPass.value.trim();
    if(!pwd){ adminLoginMsg.textContent = 'Enter a password.'; return; }
    adminLoginMsg.textContent = 'Checking...';
    try{
      const data = await jsonp({action:'login', password: pwd});
      if((data?.ok || data?.success) && (data?.token)){
        setAuthed(data.token); adminPass.value=''; adminLoginMsg.textContent=''; await adminRefresh();
      }else{
        adminLoginMsg.textContent = 'Invalid password.';
      }
    }catch{ adminLoginMsg.textContent = 'Network error.'; }
  });

  async function adminFetch(action, body={}){
    return jsonp(Object.assign({}, body, {action, token: (localStorage.getItem('adminToken')||'')}));
  }

  async function adminDeleteReview(id){
    const res = await adminFetch('deleteReview', { id });
    if(!(res?.ok || res?.success)) throw new Error(res?.error || 'Delete failed');
    return res;
  }

  async function adminRefresh(){
    // analytics
    const aRes = await adminFetch('analytics');
    const a = aRes?.data || aRes || {};
    document.getElementById('k_totalReviews').textContent = a?.totalReviews ?? '—';
    document.getElementById('k_avgRating').textContent   = a?.avgRating ? Number(a.avgRating).toFixed(2) : '—';
    document.getElementById('k_reviewsMonth').textContent= a?.reviewsThisMonth ?? '—';
    document.getElementById('k_totalQuotes').textContent = a?.totalQuotes ?? '—';
    document.getElementById('k_quotesMonth').textContent = a?.quotesThisMonth ?? '—';

    // recent quotes table
    const tbody = document.querySelector('#quotesTable tbody');
    tbody.innerHTML = (a?.recentQuotes||[]).map(q=>`
      <tr>
        <td>${safeDate(q.timestamp)}</td>
        <td>${escapeHtml(q.name||'')}</td>
        <td>${escapeHtml(q.phone||'')}</td>
        <td>${escapeHtml(q.service||'')}</td>
        <td>${escapeHtml(q.cityzip||'')}</td>
        <td>${escapeHtml(q.details||'')}</td>
      </tr>
    `).join('');

    // admin reviews list WITH delete buttons (admin-only area)
    const rBox = document.getElementById('adminReviews');
    const r = await jsonp({action:'list'}).catch(()=>[]);
    rBox.innerHTML = (r||[]).map(rv=>`
      <div class="quote" data-id="${rv.id ?? ''}">
        <div class="row-actions" style="position:absolute; top:10px; right:10px">
          ${rv.source==='facebook' ? '' : `<button type="button" class="danger" data-del="${rv.id ?? ''}">Delete</button>`}
        </div>
        <div>${'★'.repeat(+rv.stars)}${'☆'.repeat(5-+rv.stars)}</div>
        <div style="margin-top:6px">${escapeHtml(rv.text)}</div>
        <div class="by">— ${escapeHtml(rv.name)} <span style="color:var(--muted);font-weight:400">• ${safeDate(rv.timestamp)} <span class="src-tag">${rv.source==='facebook'?'Facebook':'Website'}</span></span></div>
      </div>
    `).join('') || '<div class="help">No reviews.</div>';

    rBox.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        const id = b.getAttribute('data-del');
        if(!id) return;
        if(!confirm('Delete this review?')) return;
        try{
          const res = await adminDeleteReview(id);
          if(res){ await adminRefresh(); await loadReviews(); }
        }catch(err){
          alert('Delete failed: ' + (err?.message || err));
        }
      });
    });
  }

  // ===== Timers: live refresh =====
  let pubTimer = null;
  function startPublicTimer(){ if (!pubTimer) pubTimer = setInterval(loadReviews, 15000); }
  function stopPublicTimer(){ if (pubTimer){ clearInterval(pubTimer); pubTimer = null; } }

  let adminTimer = null;
  function startAdminTimer(){
    if (!adminTimer){
      adminTimer = setInterval(()=>{
        if (adminOpen && isAuthed()) adminRefresh();
      }, 10000);
    }
  }
  function stopAdminTimer(){ if (adminTimer){ clearInterval(adminTimer); adminTimer = null; } }

  // Init
  updateNavSpacer();
  loadReviews();
  startPublicTimer();
</script>
</body>
</html>
